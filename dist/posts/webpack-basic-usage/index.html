<!DOCTYPE html><title>Webpack Basic Usage</title><link rel="canonical" href="https://lexingtonthemes.com/posts/webpack-basic-usage/"><meta name="robots" content="index, follow"><meta property="og:title" content="Webpack Basic Usage"><meta property="og:type" content="website"><meta property="og:image" content="https://source.unsplash.com/text-yXrl2lkGJ-k"><meta property="og:url" content="https://lexingtonthemes.com/posts/webpack-basic-usage/"><meta property="og:site_name" content="Littlefish's Blog"> <html lang="en"> <head><title>Littlefish's Blog</title><link rel="canonical" href="https://fishchan.me"><meta name="description" content="Littlefish's blog - posts of strugglings, thoughts and livings"><meta name="robots" content="index, follow"><meta property="og:title" content="Littlefish's Blog"><meta property="og:type" content="website"><meta property="og:image" content="https://fishchan.me/images/cover-min.jpg"><meta property="og:url" content="https://fishchan.me"><meta property="og:description" content="Littlefish's blog - posts of strugglings, thoughts and livings"><meta property="og:site_name" content="Littlefish's Blog"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="author" content="Michael Andreuzza"> <meta name="your keywords" content="Add ypour keywords here"> <!-- Favicon guidelines generated with https://favicon.io/ --> <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png"> <link rel="manifest" href="/images/favicons/site.webmanifest"> <link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#ffffff"> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="theme-color" content="#ffffff"> <link rel="manifest" href="/favicons/site.webmanifest"> <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#ffffff"> <!-- HTML in your document's head --> <link rel="preconnect" href="https://rsms.me/"> <link rel="stylesheet" href="https://rsms.me/inter/inter.css"> <link href="https://api.fontshare.com/v2/css?f[]=jet-brains-mono@1,2&display=swap" rel="stylesheet"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Gilda+Display&display=swap" rel="stylesheet"> <link rel="stylesheet" href="/_astro/index.DUjfkajj.css" />
<link rel="stylesheet" href="/_astro/_slug_.vkDdMgDA.css" /><script type="module" src="/_astro/hoisted.BR64PFV_.js"></script></head> <body class="bg-white flex flex-col min-h-screen"> <div class=" "> <div class=" px-8 md:px-12 mx-auto max-w-7xl py-2  lg:px-32 text-xs"> <div x-data="{ open: false }" class="relative flex flex-col w-full  mx-auto   rounded-xl md:rounded-full md:items-center md:justify-between md:flex-row "> <div class="flex flex-row items-center justify-between md:justify-start"> <a class="text-black hover:text-zinc-500 items-center font-normal uppercase gap-3 inline-flex " href="/">
Littlefish's blog
</a> <button @click="open = !open" class="inline-flex items-center justify-center p-2 text-black hover:text-blue-500 focus:outline-none focus:text-black md:hidden"> <svg class="w-6 h-6" stroke="currentColor" fill="none" viewBox="0 0 24 24"> <path :class="{'hidden': open, 'inline-flex': !open }" class="inline-flex" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path> <path :class="{'hidden': !open, 'inline-flex': open }" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path> </svg> </button> </div> <nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden py-12 md:py-0 md:flex md:items-end justify-center md:flex-row"> <ul class="space-y-2 list-none md:space-y-0 md:ml-auto items-center md:inline-flex justify-center text-center md:text-left gap-8"> <li> <a href="/movies" class="text-black text-md hover:text-blue-500">
電影
</a> </li> <li> <a href="https://github.com/berman82312" class="py-1.5 px-4 border focus:ring-2 h-8  rounded-full border-transparent bg-black hover:bg-black/10 text-white duration-200 focus:ring-offset-2 focus:ring-white hover:text-black inline-flex items-center justify-center ring-1 ring-transparent lg:ml-auto" target="_blank">
GitHub
</a> </li> </ul> </nav> </div> </div> </div> <main class="flex-grow"> <section> <div class="px-8 py-12 md:px-12 mx-auto lg:pt-24 max-w-7xl lg:px-32"> <div class="lg:text-center"> <div class="flex justify-center"> <img class="lg:h-auto w-auto object-cover object-center" src="https://source.unsplash.com/text-yXrl2lkGJ-k" alt="#"> </div> <div class="flex flex-col md:flex-row mt-4 justify-between"> <p class="text-xs text-zinc-500"> Fri May 05 </p> <div class="flex gap-3"> <span class="inline-flex items-center uppercase    hover:text-blue-500   text-xs font-medium text-black"> <a href="/tags/webpack">webpack</a> </span> </div> </div> <h1 class="text-4xl tracking-tight text-balance mt-12 lg:mt-16 font-medium font-display text-black md:text-8xl"> Webpack Basic Usage </h1> <p class="max-w-2xl mt-8 mx-auto text-zinc-500"> <em></em> </p> </div> <div class="mt-12 max-w-2xl mx-auto"> <div class="prose-styles">  <p>( 2017-05-03 寫作當下使用的是 webpack 2.3.3)</p>
<p>Webpack 是個神奇且好用的東西，但 webpack2 的 document 目前不盡完善，有許多狀況與細節並沒有解釋或解釋詳盡。在這裡簡單的介紹使用 Webpack 完成 Code splitting ，以及使用 Chunkhash 達成解決 File Caching 的過程。</p>
<h2 id="打包-bundle">打包 (Bundle)</h2>
<p>打包是最基本的 Webpack 功能，假設我們有個檔案叫<code>index.js</code>，裡面長得像是</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-string-expression)">'use strict'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> axios </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> require</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'axios'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-color-text)">(){</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">...</span></span></code></pre>
<p>那麼，基本的<code>webpack.config.js</code>大概定義如下</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-string-expression)">'use strict'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> webpack </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> require</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'webpack'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> path </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> require</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'path'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> config </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    entry</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        app</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> './src/index.js'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    output</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        filename</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">module</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">exports</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-color-text)"> config;</span></span></code></pre>
<p>當我們執行<code>webpack --config webpack.config.js</code>之後，webpack 大概做了以下的事情：</p>
<ol>
<li>根據<code>entry</code>的定義，知道要打包一個叫做<code>app</code>的檔案，從<code>./src/index.js</code>作為起始文件，開始讀取檔案</li>
<li><code>index.js</code>裡面<code>require('axios')</code>，因此在執行環境中尋找<code>axios</code>插件，一般會從<code>entry</code>的相對路徑以及<code>node_modules</code>裡面找。</li>
<li>把<code>index.js</code>和<code>axios</code>打包成一份檔案輸出為<code>app.js</code>，<code>output</code>的<code>[name].js</code>就是指檔案名稱用<code>entry</code>所指定的，然後檔案放置的位置以<code>path</code>指定。其中<code>__dirname</code>是指執行<code>webpack</code>指令的根目錄</li>
</ol>
<p>也就是說，我們開發可以結構化地把檔案分拆，像一般寫程式那樣。但我們不需要在 template 中用許多個<code>&#x3C;script></code>將所有<code>js</code>檔案載入，並還要注意先後順序。執行完<code>webpack</code>之後，只需要載入<code>app.js</code>就可以了。</p>
<h3 id="多個檔案打包成一個">多個檔案打包成一個</h3>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-string-expression)">'use strict'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> webpack </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> require</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'webpack'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> path </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> require</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'path'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> config </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    entry</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        app</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-string-expression)">'./src/index.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> './src/auth.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> './src/message.js'</span><span style="color:var(--astro-code-color-text)">]</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    output</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        filename</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">module</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">exports</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-color-text)"> config;</span></span></code></pre>
<p>webpack 會按照陣列的順序，一一打包檔案，然後整合為一包<code>app.js</code></p>
<h3 id="打包成多個檔案">打包成多個檔案</h3>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-string-expression)">'use strict'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> webpack </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> require</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'webpack'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> path </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> require</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'path'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> config </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    entry</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        app</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> './src/index.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        auth</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> [</span><span style="color:var(--astro-code-token-string-expression)">'./src/auth.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> './src/user.js'</span><span style="color:var(--astro-code-color-text)">]</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        message</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> './src/message.js'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    output</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        filename</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">module</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">exports</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-color-text)"> config;</span></span></code></pre>
<p>這樣設定的話，webpack 最終就會打包出三個檔案，分別是<code>app.js</code>,<code>auth.js</code>,<code>message.js</code></p>
<h2 id="拆分-code-splitting">拆分 (Code Splitting)</h2>
<p>每次執行<code>webpack</code>，webpack就會幫我們將檔案重新打包、更新。但隨著架構愈來愈大時，我們自己的檔案、使用的第三方套件增多，我們打包出來的檔案也會愈來愈肥。這對頁面載入將是個很大的負荷。有時候我們可能只是改個一兩行，但整個<code>app.js</code>就會需要更新，使用者端就需要重新載入新的一整大包。</p>
<p>但其實第三方套件並不像我們自己的 Code 那麼經常變動，通常是我們自己想升版才會更動。而且寫<code>js</code>我們會使用的第三方套件通常挺多。如果能將這些部分與我們自己的 Code 分開打包成不同的一包，在我們更新自己的 Code 的時候，只會更新我們 Code 整合的那包，不會更動到第三方套件的那一包，可以減少一定程度的 Loading 負荷。</p>
<p>首先我們將<code>webpack.config.js</code>中的 <code>config</code> 更新成</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> config </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    entry</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        app</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> './src/index.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        vendor</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'axios'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    output</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        filename</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>執行<code>webpack</code>，<code>axios</code>這個第三方套件的會被打包進<code>vendor.js</code>，但我們會發現<code>app.js</code>裡面還是有<code>axios</code>，這是因為不同的<code>entry</code>，webpack 會分開打包，各自的 dependencies 各自處理。</p>
<p>為了讓共同的第三方套件都打包成同一包，我們將<code>webpack.config.js</code>更改為</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> config </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    entry</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        app</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> './src/index.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        vendor</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'axios'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    output</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        filename</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    plugins</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> [</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        new</span><span style="color:var(--astro-code-token-constant)"> webpack</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">optimize</span><span style="color:var(--astro-code-token-function)">.CommonsChunkPlugin</span><span style="color:var(--astro-code-color-text)">({</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">            name</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'vendor'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        })</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    ]</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p><code>CommonsChunkPlugin</code>會將各個<code>entry</code>中共同的套件包裝到指定的<code>name</code>檔案。所以當我們執行<code>webpack</code>之後，我們會發現這次<code>axios</code>只出現在<code>vendor.js</code>了。</p>
<p>我們可以進一步將<code>webpack.config.js</code>再改為</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> config </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    entry</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        app</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> './src/index.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    output</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        filename</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    plugins</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> [</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        new</span><span style="color:var(--astro-code-token-constant)"> webpack</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">optimize</span><span style="color:var(--astro-code-token-function)">.CommonsChunkPlugin</span><span style="color:var(--astro-code-color-text)">({</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">            name</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'vendor'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">            minChunks</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-keyword)"> function</span><span style="color:var(--astro-code-color-text)"> (module) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">                // this assumes your vendor imports exist in the node_modules</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">                return</span><span style="color:var(--astro-code-token-constant)"> module</span><span style="color:var(--astro-code-color-text)">.context </span><span style="color:var(--astro-code-token-keyword)">&#x26;&#x26;</span><span style="color:var(--astro-code-token-constant)"> module</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">context</span><span style="color:var(--astro-code-token-function)">.indexOf</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'node_modules'</span><span style="color:var(--astro-code-color-text)">) </span><span style="color:var(--astro-code-token-keyword)">!==</span><span style="color:var(--astro-code-token-keyword)"> -</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">            }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        })</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    ]</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>其中<code>minChunks</code>是指定判定套件為共同套件的條件，將其打包進指定檔案中。若是將<code>minChunks</code>指定為 <code>2</code>，那麼就是說在各<code>entry</code>中，總共出現<code>2</code>次以上的套件就將其打包進<code>vendor.js</code>這的檔案。而我們在這邊寫的 callback，是判斷套件若是有出現在<code>node_modules</code>中的，就視為共同套件打包進<code>vendor.js</code>中。</p>
<p>值得特別注意的是在這次的<code>webpack.config.js</code>中，我們的<code>entry</code>沒有指定<code>vendor</code>，僅僅靠<code>CommonsChunkPlugin</code>完成第三方套件的打包。這在 webpack 稱為 Implicit Common Vendor Chunk。</p>
<h2 id="版本-chunkhash">版本 (Chunkhash)</h2>
<p>瀏覽器多有 Cache 的機制，static file (image, css, js…etc)會留有一份快取在 client 端。在一定時間內，若是瀏覽器發現這網站要求<code>app.js</code>，而<code>app.js</code>在本地端有一份 copy ，那瀏覽器會使用本地的<code>app.js</code> copy。這個機制是為了優化網頁的讀取，但卻造成了一個麻煩的情況。當我們更新了<code>app.js</code>，但因為檔名沒變，瀏覽器不會知道檔案內容改變了，會繼續使用本地端較舊的 copy 版本。</p>
<p>為了解決這個問題，通常的辦法是在檔案名稱加上版本號：<code>app.v1.js</code>。當我們更新<code>app.js</code>時，就更新版本號：<code>app.v2.js</code>，讓瀏覽器認為是要求一份不同的 js ，達到即時更新的效果。</p>
<p>身為一位工程師，改 code 才是我們的本職。需要在每次改 code 之後去注意版本號、手動更新，是一件麻煩且浪費我們腦內記憶體的事情。透過 webpack ，我們可以輕鬆達成這件事。</p>
<p>將<code>webpack.config.js</code>中的<code>output</code>改為</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-color-text)">output</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    filename</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].[chunkhash].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    path</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">...</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>webpack 打包檔案之後，會在檔案名自動添上一個<code>chunkhash</code>，所以我們會得到一個像是<code>app.3c75dbb16437c09415ac.js</code>的檔案名稱。每次更改 code，重新打包，webpack 就會產生一個新的 <code>chunkhash</code>，也就達成了更改版本的效果。</p>
<p>每個打包出的檔案的<code>chunkhash</code>都是 unique 的，這在打包成不同檔案的時候，可以幫助我們達到一個目的：更新<code>app.js</code>時，若<code>vendor.js</code>不需要更新，他可以維持舊的<code>chunkhash</code>，進而達到讓瀏覽器「只更新需要更新的套件」這件事。</p>
<p>但實際執行<code>webpack</code>後，我們會發現當我們更改了一小段<code>index.js</code>的 code，產出的 <code>app.[chunkhash].js</code> 和 <code>vendor.[chunkhash].js</code> 的<code>[chunkhash]</code>部分都更新了，並沒有達到預期的只更新<code>app.js</code>的效果。</p>
<p>這是因為每次 webpack 在執行打包時，會將一些 runtime code 帶進打包出的 Common Chunk 之中，也就是我們的 <code>vendor.js</code>，來幫助打包後的檔案處理引入插件。為了解決這個問題，我們再引入一個叫做 <code>manifest</code> 的檔案來處理這個問題。</p>
<h3 id="manifest">manifest</h3>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">var</span><span style="color:var(--astro-code-color-text)"> config </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    entry</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        app</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '/src/index.js'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    output</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        filename</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> '[name].[chunkhash].js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        path</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'dist'</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    plugins</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> [</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">       new</span><span style="color:var(--astro-code-token-constant)"> webpack</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">optimize</span><span style="color:var(--astro-code-token-function)">.CommonsChunkPlugin</span><span style="color:var(--astro-code-color-text)">({</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">           name</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'vendor'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">           minChunks</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-keyword)"> function</span><span style="color:var(--astro-code-color-text)"> (module) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">               return</span><span style="color:var(--astro-code-token-constant)"> module</span><span style="color:var(--astro-code-color-text)">.context </span><span style="color:var(--astro-code-token-keyword)">&#x26;&#x26;</span><span style="color:var(--astro-code-token-constant)"> module</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">context</span><span style="color:var(--astro-code-token-function)">.indexOf</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'node_modules'</span><span style="color:var(--astro-code-color-text)">) </span><span style="color:var(--astro-code-token-keyword)">!==</span><span style="color:var(--astro-code-token-keyword)"> -</span><span style="color:var(--astro-code-token-constant)">1</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">           }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       })</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">       // extract all common modules from vendor and app bundles</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">       new</span><span style="color:var(--astro-code-token-constant)"> webpack</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">optimize</span><span style="color:var(--astro-code-token-function)">.CommonsChunkPlugin</span><span style="color:var(--astro-code-color-text)">({</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">           name</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'manifest'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">       })</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    ]</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>這樣的設定下，首先 webpack 會把屬於 <code>node_modules</code> 中的第三方套件通通打包進 <code>vendor</code>，然後再把 <code>app</code> 和 <code>vendor</code> 共同的 <code>modules</code> 打包進 <code>manifest</code>。但因為 <code>vendor</code> 和 <code>app</code> 並沒有共同套件了，所以 <code>manifest</code> 最後只剩下 runtime code。</p>
<p>之後 html 只要按順序把 <code>manifest.[chunkhash].js</code>, <code>vendor.[chunkhash].js</code> 和 <code>app.[chunkhash].js</code>載入，就可以讓我們的 scripts 動起來了。雖然這樣我們多載入了一個檔案，但少變動 <code>vendor</code> 所省下的 loading 總的來說還是有益的。</p>
<h2 id="html-template">HTML template</h2>
<p>一切都已逼近完美，只差當每次執行完<code>webpack</code>，我們就要更新一次我們的 template，把新的<code>&#x3C;script></code>部分的檔案名中的<code>chunkhash</code>更新。官方的教學是透過<code>ChunkManifestPlugin</code>產出一個<code>manifest.json</code>，會帶有檔案對應的資訊，然後把它直接在 template inline 引入。這種人工的作法實在令人覺得功虧一簣。另外還有一種方法是透過<code>HtmlWebpackPlugin</code>幫我們產生一個帶有<code>chunkhash</code>版本號的<code>&#x3C;script></code>的 html template。但使用方式略複雜，而且對於 template 有需多限制，若要客製化還要再學習許多插件。</p>
<p>基於我們只是想要簡單的讓 webpack 幫我們自動換版本號而已，小魚自己實在不想為了這件事再多加入這些東西。經過一段時間的 google + stackoverflow 之後，先寫出了以下的暴力做法。</p>
<p>在<code>webpack.config.js</code>的<code>plugin</code>處多加一個自己寫的 Plugin</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-color-text)">plugins</span><span style="color:var(--astro-code-token-punctuation)">:</span><span style="color:var(--astro-code-color-text)">[</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    ...</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    function</span><span style="color:var(--astro-code-color-text)"> () {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        var</span><span style="color:var(--astro-code-color-text)"> templatePath </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.resolve</span><span style="color:var(--astro-code-color-text)">(__dirname</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'templates'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        var</span><span style="color:var(--astro-code-color-text)"> rawFilePath </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.join</span><span style="color:var(--astro-code-color-text)">(templatePath</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'src/scripts.html'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        var</span><span style="color:var(--astro-code-color-text)"> outFilePath </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> path</span><span style="color:var(--astro-code-token-function)">.join</span><span style="color:var(--astro-code-color-text)">(templatePath</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'base/partials/scripts.html'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        var</span><span style="color:var(--astro-code-color-text)"> str </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> fs</span><span style="color:var(--astro-code-token-function)">.readFileSync</span><span style="color:var(--astro-code-color-text)">(rawFilePath</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'utf8'</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        if</span><span style="color:var(--astro-code-color-text)"> (</span><span style="color:var(--astro-code-token-constant)">process</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">env</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">NODE_ENV</span><span style="color:var(--astro-code-token-keyword)"> ===</span><span style="color:var(--astro-code-token-string-expression)"> 'production'</span><span style="color:var(--astro-code-color-text)">) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">            this</span><span style="color:var(--astro-code-token-function)">.plugin</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">"done"</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-keyword)"> function</span><span style="color:var(--astro-code-color-text)"> (stats) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">                var</span><span style="color:var(--astro-code-color-text)"> counter </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> 0</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">                var</span><span style="color:var(--astro-code-token-function)"> replaceInFile</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> function</span><span style="color:var(--astro-code-color-text)"> (toReplace</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> replacement) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">                    var</span><span style="color:var(--astro-code-token-function)"> replacer</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> function</span><span style="color:var(--astro-code-color-text)"> (match) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">                        console</span><span style="color:var(--astro-code-token-function)">.log</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'Replacing %s => %s'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> match</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> replacement);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">                        return</span><span style="color:var(--astro-code-color-text)"> replacement</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">                    };</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">                    str </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-constant)"> str</span><span style="color:var(--astro-code-token-function)">.replace</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">new</span><span style="color:var(--astro-code-token-function)"> RegExp</span><span style="color:var(--astro-code-color-text)">(toReplace</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> 'g'</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> replacer);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">                    counter</span><span style="color:var(--astro-code-token-keyword)">++</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">                    if</span><span style="color:var(--astro-code-color-text)"> (counter </span><span style="color:var(--astro-code-token-keyword)">===</span><span style="color:var(--astro-code-token-constant)"> stats</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">compilation</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">chunks</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">length</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">                        fs</span><span style="color:var(--astro-code-token-function)">.writeFileSync</span><span style="color:var(--astro-code-color-text)">(outFilePath</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> str);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">                };</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">                stats</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">compilation</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">chunks</span><span style="color:var(--astro-code-token-function)">.forEach</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-color-text)"> (chunk) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">                    replaceInFile</span><span style="color:var(--astro-code-color-text)">(</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">                        chunk</span><span style="color:var(--astro-code-color-text)">.name </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-token-string-expression)"> '.js'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">                        chunk</span><span style="color:var(--astro-code-color-text)">.name </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-token-string-expression)"> '.'</span><span style="color:var(--astro-code-token-keyword)"> +</span><span style="color:var(--astro-code-token-constant)"> chunk</span><span style="color:var(--astro-code-color-text)">.renderedHash </span><span style="color:var(--astro-code-token-keyword)">+</span><span style="color:var(--astro-code-token-string-expression)"> '.js'</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">                    );</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">                });</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">            });</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        }</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">        else</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">            fs</span><span style="color:var(--astro-code-token-function)">.createReadStream</span><span style="color:var(--astro-code-color-text)">(rawFilePath)</span><span style="color:var(--astro-code-token-function)">.pipe</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">fs</span><span style="color:var(--astro-code-token-function)">.createWriteStream</span><span style="color:var(--astro-code-color-text)">(outFilePath));</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">        }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">]</span></span></code></pre>
<p>我們把<code>&#x3C;scripts></code>部分的 html 獨立成一個 template，然後直接使用<code>node</code>的<code>fs</code>來進行檔案的 I/O，讀入<code>&#x3C;script></code>的 template ，然後將檔案中的檔案名稱置換成帶有<code>chunkhash</code>的字串，再輸出成<code>production</code>用的 template。</p>
<p>我們設定<code>this.plugin</code>只在<code>NODE_ENV === 'production'</code>的時候執行，並且是在 webpack 已經打包完的<code>done</code>的階段，把結果的資訊讀出來，然後進行操作。而在開發模式下，不用多帶<code>chunkhash</code>可以省下一些麻煩，所以就略過這步驟。也可以把這段 code 寫成一個插件，然後在<code>webpack.config.js</code>引入，會讓程式碼看起來乾淨些。這邊只是一個簡單的快速介紹。</p>
<p>要注意的是，雖然官方文件說：</p>
<blockquote>
<p>Running <code>webpack -p</code> (or equivalently <code>webpack --optimize-minimize --define process.env.NODE_ENV="'production'"</code>).</p>
</blockquote>
<p>但這裡的<code>process.env.NODE_ENV</code>並不是指定你執行時的<code>NODE_ENV</code>，而是對於 webpack 而言的變數。因此若我們就這麼執行<code>webpack -p --config webpack.config.js</code>，我們寫的那段 plugin 所認得的<code>process.env.NODE_ENV</code>是執行<code>webpack</code>指令的 node 環境，而非 webpack 自己設定的變數，webpack 還是只會跑開發部分的程式碼。（小魚還沒深入去了解其中的原因）</p>
<p>要解決這個問題，你可以使用官方的<code>EnvironmentPlugin</code>來處理，或者簡單地把你的指令改成<code>NODE_ENV=production webpack -p --config webpack.config.js</code>就可以了。</p>
<p>如此一來，在 production 環境下執行 <code>NODE_ENV=production webpack -p --config webpack.config.js</code>，webpack 就會幫我們把檔案打包好，加上<code>chunkhash</code>，然後再幫我們更改<code>&#x3C;script></code>的 template 了。</p>
<h2 id="結語">結語</h2>
<p>這只是最、最、最基本的 webpack 功能，完全還無法體現 webpack 的強大之處。webpack 的各種插件、各類型檔案的花式打包、各種玄妙的 bundle 設定⋯⋯才是 webpack 強大且非同凡響的地方。不然其實以上這些功能，使用其他的打包工具也是能達到相同效果的。</p>
<p>這次只是簡單介紹了一下 webpack 最基本的使用與設定，若要深入感受 webpack 的強大，還是要多去瞭解與研究。</p>  </div> </div> </div> </section> </main> <footer class="bg-white border-t"> <div class="px-8 md:px-12 mx-auto max-w-7xl py-6 lg:px-32"> <section class="gap-y-6 gap-x-8"> <div> <p class="text-sm text-zinc-600 lg:col-span-2" x-data="{ year: new Date().getFullYear() }">
© <span x-text="year"></span> Littlefish's Blog. All rights reserved. Theme is inspired by <a class="text-sm text-black hover:text-accent-400 underline" href="https://github.com/michael-andreuzza/microblog">Microblog</a>.
</p> </div> </section> </div> </footer> </body></html>